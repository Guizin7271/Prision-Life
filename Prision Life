local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local TweenService = game:GetService("TweenService")

local State = {
    AimbotEnabled = false,
    ESPEnabled = false,
    FOVEnabled = false,
    FOVRadius = 50,
    Target = nil,
    DrawingObjects = {},
    SpeedEnabled = false,
    SpeedValue = 50,
    InfJumpEnabled = false,
    RGBHue = 0
}

local Utils = {}

function Utils:CreateDrawing(t, p)
    local success, drawing = pcall(function()
        local d = Drawing.new(t)
        for k,v in pairs(p) do
            d[k] = v
        end
        return d
    end)
    return success and drawing or nil
end

-- DETEC√á√ÉO DE TIMES
function Utils:GetPlayerTeam(plr)
    if not plr or not plr.Team then return "Prisoner" end
    local teamName = plr.Team.Name
    if teamName == "Guards" or teamName == "Guard" then
        return "Guard"
    elseif teamName == "Criminals" or teamName == "Criminal" then
        return "Criminal"
    else
        return "Prisoner"
    end
end

function Utils:GetTeamColor(plr)
    local team = Utils:GetPlayerTeam(plr)
    if team == "Guard" then
        return Color3.fromRGB(0, 100, 255) -- Azul
    elseif team == "Criminal" then
        return Color3.fromRGB(255, 0, 0) -- Vermelho
    else
        return Color3.fromRGB(255, 140, 0) -- Laranja
    end
end

-- TEAM CHECK (fixo ativado)
function Utils:IsSameTeam(plr1, plr2)
    if not plr1 or not plr2 then return false end
    return Utils:GetPlayerTeam(plr1) == Utils:GetPlayerTeam(plr2)
end

-- WALL CHECK (fixo ativado)
function Utils:IsVisible(plr)
    if not plr or not plr.Character or not plr.Character:FindFirstChild("Head") then 
        return false 
    end
    
    local head = plr.Character.Head
    local origin = Camera.CFrame.Position
    local direction = (head.Position - origin).Unit * (head.Position - origin).Magnitude
    
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {LocalPlayer.Character, plr.Character}
    
    local result = workspace:Raycast(origin, direction, params)
    return result == nil
end

-- AIMBOT MODULE
local AimbotModule = {}

function AimbotModule:GetClosest()
    local closest = nil
    local shortestDist = State.FOVRadius
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
            
            if Utils:IsSameTeam(LocalPlayer, plr) then
                continue
            end
            
            if not Utils:IsVisible(plr) then
                continue
            end
            
            local head = plr.Character.Head
            local pos, onScreen = Camera:WorldToViewportPoint(head.Position)
            
            if onScreen then
                local dist = (Vector2.new(pos.X, pos.Y) - center).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    closest = plr
                end
            end
        end
    end
    
    return closest
end

function AimbotModule:Update()
    if State.AimbotEnabled then
        State.Target = AimbotModule:GetClosest()
    else
        State.Target = nil
    end
end

function AimbotModule:Aimbot()
    if State.Target and State.Target.Character and State.Target.Character:FindFirstChild("Head") then
        Camera.CFrame = CFrame.lookAt(Camera.CFrame.Position, State.Target.Character.Head.Position)
    end
end

-- ESP MODULE
local ESPModule = {}

function ESPModule:CreateESP(plr)
    if plr == LocalPlayer then return end
    
    if State.DrawingObjects[plr] then
        pcall(function()
            State.DrawingObjects[plr]:Remove()
        end)
    end
    
    local box = Utils:CreateDrawing("Square", {
        Color = Utils:GetTeamColor(plr),
        Thickness = 2,
        Filled = false,
        Transparency = 1,
        Visible = false,
        Size = Vector2.new(0, 0),
        Position = Vector2.new(0, 0)
    })
    
    State.DrawingObjects[plr] = box
end

function ESPModule:RemoveESP(plr)
    if State.DrawingObjects[plr] then
        pcall(function()
            State.DrawingObjects[plr]:Remove()
        end)
        State.DrawingObjects[plr] = nil
    end
end

function ESPModule:UpdateESP()
    if not State.ESPEnabled then
        for plr, box in pairs(State.DrawingObjects) do
            if box then
                pcall(function()
                    box.Visible = false
                end)
            end
        end
        return
    end
    
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            if not State.DrawingObjects[plr] then
                ESPModule:CreateESP(plr)
            end
            
            local box = State.DrawingObjects[plr]
            if box then
                local char = plr.Character
                if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
                    local root = char.HumanoidRootPart
                    
                    local topPos, onScreen1 = Camera:WorldToViewportPoint(root.Position + Vector3.new(0, 3, 0))
                    local bottomPos, onScreen2 = Camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
                    
                    if onScreen1 and onScreen2 and topPos.Z > 0 then
                        local height = math.abs(topPos.Y - bottomPos.Y)
                        local width = height * 0.6
                        
                        box.Size = Vector2.new(width, height)
                        box.Position = Vector2.new(topPos.X - width/2, topPos.Y)
                        box.Color = Utils:GetTeamColor(plr)
                        box.Visible = true
                    else
                        box.Visible = false
                    end
                else
                    box.Visible = false
                end
            end
        end
    end
end

-- FOV Module
local FOVModule = {}

function FOVModule:Create()
    return Utils:CreateDrawing("Circle", {
        Radius = State.FOVRadius,
        Thickness = 2,
        Color = Color3.fromRGB(255, 255, 255),
        Filled = false,
        Visible = false,
        Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    })
end

function FOVModule:Update()
    if not State.FOVCircle then
        State.FOVCircle = FOVModule:Create()
    end
    
    if State.FOVCircle then
        if State.FOVEnabled then
            State.RGBHue = (State.RGBHue + 2) % 360
            State.FOVCircle.Color = Color3.fromHSV(State.RGBHue/360, 1, 1)
            State.FOVCircle.Radius = State.FOVRadius
            State.FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
        end
        State.FOVCircle.Visible = State.FOVEnabled
    end
end

-- Player Module
local PlayerModule = {}

function PlayerModule:UpdateSpeed()
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid.WalkSpeed = State.SpeedEnabled and State.SpeedValue or 16
    end
end

-- Infinite Jump
UserInputService.JumpRequest:Connect(function()
    if State.InfJumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

-- TP MODULE
local TPModule = {}

function TPModule:SmoothTeleport(targetCFrame)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    local root = LocalPlayer.Character.HumanoidRootPart
    root.CFrame = targetCFrame
end

-- BOT√ÉO 1: TP Guard Base
function TPModule:GuardBase()
    local guardSpawn = CFrame.new(817.1441040039062, 99.97665405273438, 2231.611572265625)
    TPModule:SmoothTeleport(guardSpawn)
    Rayfield:Notify({
        Title = "Teleportado!",
        Content = "Voc√™ foi para a Base dos Guardas",
        Duration = 3
    })
end

-- BOT√ÉO 2: TP Area
function TPModule:TPArea()
    local areaCFrame = CFrame.new(793.1149291992188, 98.18993377685547, 2537.293212890625)
    TPModule:SmoothTeleport(areaCFrame)
    Rayfield:Notify({
        Title = "Teleportado!",
        Content = "Voc√™ foi para a √Årea Externa",
        Duration = 3
    })
end

-- BOT√ÉO 3: TP Criminal Base
function TPModule:CriminalBase()
    local criminalSpawn = CFrame.new(-934.0503540039062, 94.12886810302734, 2044.403076171875)
    TPModule:SmoothTeleport(criminalSpawn)
    Rayfield:Notify({
        Title = "Teleportado!",
        Content = "Voc√™ foi para a Base Criminal",
        Duration = 3
    })
end

-- GUI
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Prison Life Hub",
    LoadingTitle = "Carregando...",
    ConfigurationSaving = {Enabled = false}
})

local Tab1 = Window:CreateTab("Aimbot & ESP", 4483362458)

Tab1:CreateToggle({
    Name = "Aimbot", 
    CurrentValue = false, 
    Callback = function(v) 
        State.AimbotEnabled = v 
        if not v then State.Target = nil end
    end
})

Tab1:CreateToggle({
    Name = "ESP Box", 
    CurrentValue = false, 
    Callback = function(v) 
        State.ESPEnabled = v 
        if not v then
            for _, box in pairs(State.DrawingObjects) do
                pcall(function() box.Visible = false end)
            end
        end
    end
})

Tab1:CreateToggle({
    Name = "FOV RGB", 
    CurrentValue = false, 
    Callback = function(v) State.FOVEnabled = v end
})

Tab1:CreateSlider({
    Name = "FOV Tamanho", 
    Range = {10, 300}, 
    Increment = 5, 
    CurrentValue = 50, 
    Callback = function(v) State.FOVRadius = v end
})

local Tab2 = Window:CreateTab("Jogador", 4483362458)

-- Speed Hack com aviso de risco
Tab2:CreateToggle({
    Name = "Speed Hack (‚ö†Ô∏è Risco de Kick e Ban)", 
    CurrentValue = false, 
    Callback = function(v) 
        State.SpeedEnabled = v 
        PlayerModule:UpdateSpeed() 
        if v then
            Rayfield:Notify({
                Title = "‚ö†Ô∏è AVISO ‚ö†Ô∏è",
                Content = "Speed Hack pode causar Kick ou Ban! Use por sua conta e risco.",
                Duration = 5
            })
        end
    end
})

Tab2:CreateSlider({
    Name = "Velocidade", 
    Range = {16, 200}, 
    Increment = 5, 
    CurrentValue = 50, 
    Callback = function(v) 
        State.SpeedValue = v 
        if State.SpeedEnabled then 
            PlayerModule:UpdateSpeed() 
        end 
    end
})

Tab2:CreateToggle({
    Name = "Infinite Jump", 
    CurrentValue = false, 
    Callback = function(v) State.InfJumpEnabled = v end
})

-- ABA TP
local Tab3 = Window:CreateTab("TP", 4483362458)

Tab3:CreateButton({
    Name = "TP Guard Base",
    Callback = function()
        TPModule:GuardBase()
    end
})

Tab3:CreateButton({
    Name = "TP Area",
    Callback = function()
        TPModule:TPArea()
    end
})

Tab3:CreateButton({
    Name = "TP Criminal Base",
    Callback = function()
        TPModule:CriminalBase()
    end
})

-- ABA DE UPDATES
local Tab4 = Window:CreateTab("updates‚ùïÔ∏è", 4483362458)

Tab4:CreateLabel("üì¢ ULTIMOS UPDATES")
Tab4:CreateLabel("‚ú® FOV RGB")
Tab4:CreateLabel("‚ú® Aba Jogador com Speed e InfJump")
Tab4:CreateLabel("‚ú® Aba de Teleporte")
Tab4:CreateLabel("üîú Mais updates em breve! ü§ó‚ò∫Ô∏è")
Tab4:CreateLabel("üë§ Sou uma √∫nica pessoa")
Tab4:CreateLabel("‚è≥ Isso faz que os scripts")
Tab4:CreateLabel("   demorem mais me desculpe üò¢")
Tab4:CreateLabel("‚ö†Ô∏è Foco principal: Prison Life")

-- Inicializa√ß√£o
State.FOVCircle = FOVModule:Create()

for _, plr in pairs(Players:GetPlayers()) do
    if plr ~= LocalPlayer then
        ESPModule:CreateESP(plr)
    end
end

Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then
        ESPModule:CreateESP(plr)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    ESPModule:RemoveESP(plr)
end)

RunService.RenderStepped:Connect(function()
    FOVModule:Update()
    AimbotModule:Update()
    
    if State.AimbotEnabled and State.Target then
        AimbotModule:Aimbot()
    end
    
    ESPModule:UpdateESP()
    
    if State.SpeedEnabled then
        PlayerModule:UpdateSpeed()
    end
end)

-- Notifica√ß√£o
Rayfield:Notify({
    Title = "Carregado!",
    Content = "Updates‚ùïÔ∏è confira as novidades!",
    Duration = 6
})
